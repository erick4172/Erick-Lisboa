import React, { useState, useEffect, useRef } from 'react';
import { 
  Layout, 
  CheckSquare, 
  Briefcase, 
  Table, 
  Plus, 
  Trash2, 
  Settings, 
  Download, 
  CheckCircle, 
  Circle, 
  Clock, 
  TrendingUp, 
  AlertTriangle, 
  AlertCircle, 
  Share2, 
  Search, 
  Lock, 
  Copy, 
  LogOut,
  User,
  Calendar,
  Hourglass,
  MessageSquare,
  ThumbsUp,
  RefreshCw,
  FileText,
  DollarSign,
  XCircle,
  ChevronDown,
  ChevronUp,
  Percent,
  Coins,
  Edit3,
  Minus,
  Save,
  Pencil,
  Printer,
  Users,
  ShoppingBag,
  Send,
  X,
  UserPlus,
  Rocket,
  MoreVertical,
  ArrowRight,
  KeyRound,
  LogIn,
  ArrowLeft // Importado para o √≠cone de voltar
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken,
  onAuthStateChanged,
  GoogleAuthProvider,
  signInWithPopup,
  signOut
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc, 
  deleteDoc, 
  doc, 
  query, 
  onSnapshot, 
  orderBy, 
  serverTimestamp,
  setDoc,
  getDoc,
  getDocs,
  where,
  writeBatch
} from 'firebase/firestore';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Seguran√ßa ---
const ACCESS_HASH = "RVJJQ0s0MTcy"; 

// --- Componentes UI Reutiliz√°veis ---

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow duration-300 ${className}`}>
    {children}
  </div>
);

const Button = ({ children, onClick, variant = 'primary', icon: Icon, className = "", ...props }) => {
  const baseStyle = "flex items-center justify-center gap-2 px-5 py-2.5 rounded-xl font-semibold transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed";
  const variants = {
    primary: "bg-lime-500 text-white hover:bg-lime-600 shadow-md shadow-lime-200 hover:shadow-lg hover:shadow-lime-300",
    secondary: "bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 hover:border-slate-300",
    danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-100",
    ghost: "text-slate-500 hover:bg-slate-100 hover:text-slate-700",
    client: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-md shadow-indigo-200",
    success: "bg-emerald-500 text-white hover:bg-emerald-600 shadow-md shadow-emerald-200",
    warning: "bg-amber-500 text-white hover:bg-amber-600 shadow-md shadow-amber-200",
    outline: "bg-transparent border-2 border-slate-200 text-slate-600 hover:border-lime-500 hover:text-lime-600",
    info: "bg-sky-500 text-white hover:bg-sky-600 shadow-md shadow-sky-200",
    cta: "bg-slate-900 text-white hover:bg-slate-800 shadow-lg shadow-slate-300",
    google: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50 shadow-sm hover:shadow-md transition-all font-medium"
  };

  return (
    <button onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`} {...props}>
      {Icon && <Icon size={18} />}
      {children}
    </button>
  );
};

const Badge = ({ status }) => {
  const styles = {
    'A Fazer': 'bg-slate-100 text-slate-600 border-slate-200',
    'Em Andamento': 'bg-lime-100 text-lime-700 border-lime-200',
    'Conclu√≠do': 'bg-emerald-100 text-emerald-700 border-emerald-200',
    'Triagem': 'bg-purple-100 text-purple-700 border-purple-200',
    'An√°lise': 'bg-sky-100 text-sky-700 border-sky-200',
    'Execu√ß√£o': 'bg-blue-100 text-blue-700 border-blue-200',
    'Revis√£o': 'bg-pink-100 text-pink-700 border-pink-200',
    'Entregue': 'bg-teal-100 text-teal-700 border-teal-200',
    'Altera√ß√£o': 'bg-amber-100 text-amber-700 border-amber-200',
    'Cancelado': 'bg-red-100 text-red-700 border-red-200',
    'Aprovado': 'bg-emerald-100 text-emerald-700 border-emerald-200',
    'Pendente': 'bg-slate-100 text-slate-600 border-slate-200',
    'Em Negocia√ß√£o': 'bg-amber-100 text-amber-700 border-amber-200',
    'Rejeitado': 'bg-red-100 text-red-700 border-red-200'
  };
  return (
    <span className={`px-3 py-1 rounded-full text-xs font-bold border ${styles[status] || styles['A Fazer']}`}>
      {status}
    </span>
  );
};

// --- Helpers ---

const getDaysDiff = (dateString) => {
  if (!dateString) return 0;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const target = new Date(dateString);
  target.setHours(0, 0, 0, 0);
  const diffTime = target - today;
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
};

const calculateTimeProgress = (startStr, endStr) => {
  if (!startStr || !endStr) return 0;
  const start = new Date(startStr).getTime();
  const end = new Date(endStr).getTime();
  const now = new Date().getTime();
  if (end <= start) return 0;
  if (now < start) return 0;
  if (now > end) return 100;
  const totalDuration = end - start;
  const elapsed = now - start;
  return Math.round((elapsed / totalDuration) * 100);
};

const formatCurrency = (value) => {
  if (!value && value !== 0) return 'R$ 0,00';
  return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
};

const generateBudgetNumber = () => {
    return Math.floor(100000 + Math.random() * 900000).toString();
};

const getClientId = (name) => name ? name.toLowerCase().trim().replace(/\s+/g, '_') : 'unknown';

// --- App Principal ---

export default function PlannerApp() {
  const [user, setUser] = useState(null);
  const [viewMode, setViewMode] = useState('landing'); 
  const [activeTab, setActiveTab] = useState('dashboard');
  const [tasks, setTasks] = useState([]); 
  const [clients, setClients] = useState([]); 
  const [budgets, setBudgets] = useState([]); 
  const [clientsMetadata, setClientsMetadata] = useState({});
  const [loading, setLoading] = useState(true);
  
  // Modais
  const [newTaskModalOpen, setNewTaskModalOpen] = useState(false);
  const [clientModalOpen, setClientModalOpen] = useState(false);
  const [budgetModalOpen, setBudgetModalOpen] = useState(false);
  const [printModalOpen, setPrintModalOpen] = useState(false); 
  const [shareModalOpen, setShareModalOpen] = useState(false);
  const [lastGeneratedCode, setLastGeneratedCode] = useState('');
  const [creditEditModal, setCreditEditModal] = useState({ open: false, clientName: '', currentCredits: 0 });
  const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: '', message: '', onConfirm: null, variant: 'danger', confirmText: 'Confirmar' });
  
  // Controle de Edi√ß√£o e Resposta
  const [editingId, setEditingId] = useState(null);
  const [replyingId, setReplyingId] = useState(null); 
  const [replyText, setReplyText] = useState(''); 

  // Portal
  const [printData, setPrintData] = useState(null);
  const [trackingCode, setTrackingCode] = useState('');
  const [clientViewData, setClientViewData] = useState(null);
  const [clientLoading, setClientLoading] = useState(false);
  const [revisionMode, setRevisionMode] = useState(false); 
  const [budgetProposalMode, setBudgetProposalMode] = useState(false); 
  const [proposalText, setProposalText] = useState('');
  const [revisionText, setRevisionText] = useState('');
  const [proposalValue, setProposalValue] = useState('');

  // Novo State: Lista de projetos do cliente logado via Google
  const [clientProjects, setClientProjects] = useState([]);

  // Forms
  const [newClientData, setNewClientData] = useState({ name: '', address: '', phone: '', email: '', photoUrl: '', credits: 0, useCredits: false });
  const [newBudgetData, setNewBudgetData] = useState({ 
      title: '', isExistingClient: true, clientName: '', clientPhone: '', clientEmail: '', clientAddress: '', 
      value: '', discount: '', description: '', date: new Date().toISOString().split('T')[0], items: [], autoRegisterClient: false, clientPhotoUrl: ''
  });
  const [newTaskData, setNewTaskData] = useState({
    title: '', description: '', clientName: '', value: '', category: 'Geral', status: 'A Fazer', type: 'task',
    date: new Date().toISOString().split('T')[0], startTime: '', endTime: '', priority: 'M√©dia', manualProgress: 0, budgetNumber: '' 
  });

  // --- Auth & Data ---
  useEffect(() => {
    const initAuth = async () => {
      // Se j√° temos um token, usa ele. Se n√£o, tenta anonimo.
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        // Tenta manter sess√£o existente ou inicia anonimamente
        if (!auth.currentUser) {
            try {
               await signInAnonymously(auth);
            } catch(e) {
               console.error("Auth initialization error", e);
            }
        }
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
        setUser(currentUser);
        if (currentUser && currentUser.email && viewMode === 'landing') {
            loadClientProjects(currentUser.email);
        }
    });
    return () => unsubscribe();
  }, [viewMode]);

  const loadClientProjects = (email) => {
      if (!email) return;
      const q = query(
          collection(db, 'artifacts', appId, 'public', 'data', 'tracking_portal'), 
          where('clientEmail', '==', email)
      );
      
      const unsubscribe = onSnapshot(q, (snapshot) => {
          const projects = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
          projects.sort((a,b) => (b.lastUpdate?.seconds || 0) - (a.lastUpdate?.seconds || 0));
          setClientProjects(projects);
      });
      return unsubscribe;
  };

  useEffect(() => {
    if (!user || viewMode !== 'manager') return; 
    const qTasks = query(collection(db, 'artifacts', appId, 'users', user.uid, 'planner_tasks'), orderBy('createdAt', 'desc'));
    const unsubTasks = onSnapshot(qTasks, (snap) => setTasks(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
    const qClients = query(collection(db, 'artifacts', appId, 'users', user.uid, 'planner_clients_db'), orderBy('name'));
    const unsubClients = onSnapshot(qClients, (snap) => setClients(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
    const qBudgets = query(collection(db, 'artifacts', appId, 'users', user.uid, 'planner_budgets'), orderBy('createdAt', 'desc'));
    const unsubBudgets = onSnapshot(qBudgets, (snap) => setBudgets(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
    const qClientsMeta = query(collection(db, 'artifacts', appId, 'users', user.uid, 'planner_clients'));
    const unsubClientsMeta = onSnapshot(qClientsMeta, (snapshot) => {
        const metadata = {};
        snapshot.docs.forEach(doc => { metadata[doc.id] = doc.data(); });
        setClientsMetadata(metadata);
    });
    return () => { unsubTasks(); unsubClients(); unsubBudgets(); unsubClientsMeta(); };
  }, [user, viewMode]);

  // --- Helpers ---
  const handleCopy = (text) => {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    alert('Copiado!');
  };

  const getClientPhoto = (clientName) => {
      const client = clients.find(c => c.name === clientName);
      return client?.photoUrl || null;
  };

  const requestConfirm = ({ title, message, onConfirm, variant = 'danger', confirmText = 'Confirmar' }) => {
      setConfirmModal({ isOpen: true, title, message, onConfirm, variant, confirmText });
  };

  // --- LOGIN GOOGLE ---
  const handleGoogleLogin = async () => {
    const provider = new GoogleAuthProvider();
    setClientLoading(true);
    try {
        await signInWithPopup(auth, provider);
    } catch (error) {
        console.error("Erro no login Google:", error);
        if (error.code === 'auth/unauthorized-domain') {
            alert("Aviso: O dom√≠nio atual n√£o est√° autorizado para login com Google. Por favor, utilize o C√≥digo de Acesso para testar.");
        } else {
            alert(`Erro ao conectar com Google: ${error.message}`);
        }
    } finally {
        setClientLoading(false);
    }
  };

  const handleLogout = async () => {
    await signOut(auth);
    setClientProjects([]);
    setClientViewData(null);
    signInAnonymously(auth); 
  };

  // --- CRUD GERAL (Clientes, Or√ßamentos, Tarefas) ---

  const openClientModal = (client = null) => {
      if (client) {
          setEditingId(client.id);
          setNewClientData({
            name: client.name || '',
            address: client.address || '',
            phone: client.phone || '',
            email: client.email || '',
            photoUrl: client.photoUrl || '',
            credits: client.credits || 0,
            useCredits: client.useCredits || false
          });
      } else {
          setEditingId(null);
          setNewClientData({ name: '', address: '', phone: '', email: '', photoUrl: '', credits: 0, useCredits: false });
      }
      setClientModalOpen(true);
  };

  const handleSaveClient = async (e) => {
      e.preventDefault();
      try {
          if (editingId) {
              await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'planner_clients_db', editingId), newClientData);
          } else {
              await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'planner_clients_db'), {
                  ...newClientData,
                  createdAt: serverTimestamp()
              });
          }
          if (newClientData.useCredits) {
              const clientId = getClientId(newClientData.name);
              await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'planner_clients', clientId), {
                  name: newClientData.name,
                  credits: Number(newClientData.credits),
                  useCredits: true,
                  lastUpdate: serverTimestamp()
              }, { merge: true });
          }
          setClientModalOpen(false);
      } catch (error) { console.error(error); }
  };

  const handleDeleteClient = (id) => {
      requestConfirm({
          title: "Excluir Cliente",
          message: "Esta a√ß√£o √© irrevers√≠vel.",
          onConfirm: async () => await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'planner_clients_db', id))
      });
  };

  const updateClientCredits = async (clientName, newCredits) => {
      if (!user) return;
      const clientId = getClientId(clientName);
      try {
          await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'planner_clients', clientId), {
              name: clientName,
              credits: Number(newCredits),
              useCredits: true,
              lastUpdate: serverTimestamp()
          }, { merge: true });
      } catch (error) { console.error(error); }
  };

  // --- Budgets ---
  const openBudgetModal = (budget = null) => {
      if (budget) {
          setEditingId(budget.id);
          setNewBudgetData({ 
            ...budget, 
            isExistingClient: true, 
            title: budget.title || '',
            clientName: budget.clientName || '',
            value: budget.value !== undefined ? budget.value : '',
            discount: budget.discount !== undefined ? budget.discount : '',
            description: budget.description || '',
            date: budget.date || new Date().toISOString().split('T')[0],
            items: budget.items || [],
            clientPhone: budget.clientPhone || '',
            clientEmail: budget.clientEmail || '',
            clientAddress: budget.clientAddress || '',
            clientPhotoUrl: budget.clientPhotoUrl || '', 
            autoRegisterClient: false
          }); 
      } else {
          setEditingId(null);
          setNewBudgetData({ 
            title: '', 
            isExistingClient: true, 
            clientName: '', 
            value: '', 
            discount: '', 
            description: '', 
            date: new Date().toISOString().split('T')[0], 
            items: [], 
            autoRegisterClient: false,
            clientPhone: '',
            clientEmail: '',
            clientAddress: '',
            clientPhotoUrl: ''
          });
      }
      setBudgetModalOpen(true);
  };

  const addBudgetItem = () => setNewBudgetData({...newBudgetData, items: [...newBudgetData.items, { id: Date.now(), description: '', quantity: 1, price: 0 }]});
  const updateBudgetItem = (id, field, value) => {
      const updatedItems = newBudgetData.items.map(item => item.id === id ? { ...item, [field]: value } : item);
      setNewBudgetData({ ...newBudgetData, items: updatedItems });
  };
  const removeBudgetItem = (id) => setNewBudgetData({ ...newBudgetData, items: newBudgetData.items.filter(item => item.id !== id) });
  const calculateBudgetTotal = (items) => items ? items.reduce((acc, item) => acc + (item.quantity * item.price), 0) : 0;

  const handleSaveBudget = async (e) => {
      e.preventDefault();
      try {
          const subtotal = calculateBudgetTotal(newBudgetData.items);
          let isTempClient = !newBudgetData.isExistingClient;
          if (!newBudgetData.isExistingClient && newBudgetData.autoRegisterClient) {
              await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'planner_clients_db'), {
                  name: newBudgetData.clientName,
                  address: newBudgetData.clientAddress || '',
                  phone: newBudgetData.clientPhone || '',
                  email: newBudgetData.clientEmail || '',
                  photoUrl: newBudgetData.clientPhotoUrl || '',
                  createdAt: serverTimestamp(),
                  origin: 'budget_auto_register'
              });
              isTempClient = false; 
          }
          const budgetData = {
              title: newBudgetData.title,
              clientName: newBudgetData.clientName,
              value: subtotal,
              discount: Number(newBudgetData.discount) || 0,
              items: newBudgetData.items,
              description: newBudgetData.description,
              clientAddress: newBudgetData.clientAddress || '',
              clientPhone: newBudgetData.clientPhone || '',
              clientEmail: newBudgetData.clientEmail || '',
              clientPhotoUrl: newBudgetData.clientPhotoUrl || '', 
          };
          if (editingId) {
              const budgetRef = doc(db, 'artifacts', appId, 'users', user.uid, 'planner_budgets', editingId);
              await updateDoc(budgetRef, budgetData);
              if (newBudgetData.trackingCode) {
                  const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'tracking_portal', newBudgetData.trackingCode);
                  await updateDoc(publicRef, { ...budgetData, lastUpdate: serverTimestamp() });
              }
          } else {
              const budgetNum = generateBudgetNumber();
              const autoCode = Math.random().toString(36).substring(2, 8).toUpperCase();
              const newDoc = {
                  ...budgetData,
                  budgetNumber: budgetNum,
                  status: 'Pendente',
                  trackingCode: autoCode,
                  isTempClient: isTempClient,
                  createdAt: serverTimestamp()
              };
              const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'planner_budgets'), newDoc);
              await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tracking_portal', autoCode), {
                  ...newDoc,
                  providerName: "Planner Pro Services",
                  ownerId: user.uid,
                  type: 'budget',
                  budgetId: docRef.id,
                  lastUpdate: serverTimestamp()
              });
              setLastGeneratedCode(autoCode);
              setShareModalOpen(true);
          }
          setBudgetModalOpen(false);
      } catch (error) { console.error(error); }
  };

  // --- Projects ---
  const openProjectModal = (task = null) => {
      if (task) {
          setEditingId(task.id);
          setNewTaskData({
            ...task,
            title: task.title || '',
            description: task.description || '',
            clientName: task.clientName || '',
            value: task.value !== undefined ? task.value : '',
            category: task.category || 'Geral',
            status: task.status || 'A Fazer',
            type: task.type || 'service',
            date: task.date || new Date().toISOString().split('T')[0],
            startTime: task.startTime || '',
            endTime: task.endTime || '',
            priority: task.priority || 'M√©dia',
            manualProgress: task.manualProgress || 0,
            budgetNumber: task.budgetNumber || ''
          });
      } else {
          setEditingId(null);
          setNewTaskData({ title: '', description: '', clientName: '', value: '', category: 'Geral', status: 'A Fazer', type: 'service', date: new Date().toISOString().split('T')[0], startTime: '', endTime: '', priority: 'M√©dia', manualProgress: 0, budgetNumber: '' });
      }
      setNewTaskModalOpen(true);
  };

  const handleSaveTask = async (e) => {
    e.preventDefault();
    if (!user || !newTaskData.title) return;
    try {
        if (editingId) {
            const taskRef = doc(db, 'artifacts', appId, 'users', user.uid, 'planner_tasks', editingId);
            await updateDoc(taskRef, newTaskData);
            if (newTaskData.trackingCode) {
                const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'tracking_portal', newTaskData.trackingCode);
                await updateDoc(publicRef, { ...newTaskData, lastUpdate: serverTimestamp() });
            }
        } else {
            let finalStatus = newTaskData.status;
            if (newTaskData.type === 'service' && finalStatus === 'A Fazer') finalStatus = 'Triagem';
            const autoCode = newTaskData.type === 'service' ? Math.random().toString(36).substring(2, 8).toUpperCase() : null;
            const docData = { ...newTaskData, status: finalStatus, trackingCode: autoCode, createdAt: serverTimestamp() };
            const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'planner_tasks'), docData);
            if (newTaskData.type === 'service' && autoCode) {
                const publicData = { ...newTaskData, status: finalStatus, providerName: "Planner Pro Services", ownerId: user.uid, taskId: docRef.id, lastUpdate: serverTimestamp() };
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tracking_portal', autoCode), publicData);
                setLastGeneratedCode(autoCode); setShareModalOpen(true);
            }
        }
        setNewTaskModalOpen(false);
    } catch (error) { console.error(error); }
  };

  // --- ACTIONS ---
  const saveClientFromBudget = async (budget) => {
      try {
          await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'planner_clients_db'), {
              name: budget.clientName,
              address: budget.clientAddress || '',
              phone: budget.clientPhone || '',
              email: budget.clientEmail || '',
              photoUrl: budget.clientPhotoUrl || '', 
              createdAt: serverTimestamp(),
              origin: 'budget_conversion'
          });
          await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'planner_budgets', budget.id), { isTempClient: false });
          alert(`Cliente ${budget.clientName} cadastrado com sucesso!`);
      } catch (error) { alert("Erro ao salvar cliente."); }
  };

  const convertBudgetToService = (budget) => {
      requestConfirm({
          title: "Aprovar Or√ßamento",
          message: "Criar novo servi√ßo a partir deste or√ßamento?",
          variant: "success",
          confirmText: "Sim, Criar Servi√ßo",
          onConfirm: async () => {
              const subtotal = budget.items ? budget.items.reduce((acc, item) => acc + (item.quantity * item.price), 0) : (Number(budget.value) || 0);
              const finalValue = subtotal - (Number(budget.discount) || 0);
              const autoCode = Math.random().toString(36).substring(2, 8).toUpperCase();
              const serviceData = {
                  title: budget.title, description: budget.description, clientName: budget.clientName, value: finalValue, 
                  items: budget.items || [], category: 'Geral', status: 'Triagem', type: 'service', priority: 'M√©dia', 
                  manualProgress: 0, trackingCode: autoCode, budgetNumber: budget.budgetNumber, createdAt: serverTimestamp()
              };
              const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'planner_tasks'), serviceData);
              const publicData = { ...serviceData, providerName: "Planner Pro Services", ownerId: user.uid, taskId: docRef.id, lastUpdate: serverTimestamp() };
              await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tracking_portal', autoCode), publicData);
              await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'planner_budgets', budget.id), { status: 'Aprovado' });
              if(budget.trackingCode) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tracking_portal', budget.trackingCode), { status: 'Aprovado' });
              alert("Servi√ßo criado!"); setActiveTab('pipeline');
          }
      });
  };

  const updateTaskField = async (taskId, field, value) => {
      const taskRef = doc(db, 'artifacts', appId, 'users', user.uid, 'planner_tasks', taskId);
      await updateDoc(taskRef, { [field]: value });
      const task = tasks.find(t => t.id === taskId);
      if (task && task.trackingCode) {
          const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'tracking_portal', task.trackingCode);
          await updateDoc(publicRef, { [field]: value, lastUpdate: serverTimestamp() });
      }
  };

  const cancelTask = (taskId) => requestConfirm({ title: "Cancelar Servi√ßo", message: "Mover para cancelados?", onConfirm: async () => { await updateTaskField(taskId, 'status', 'Cancelado'); } });
  const deleteTask = (taskId) => requestConfirm({ title: "Excluir Servi√ßo", message: "Excluir permanentemente?", onConfirm: async () => { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'planner_tasks', taskId)); } });
  const deleteBudget = (id) => requestConfirm({ title: "Excluir Or√ßamento", message: "Excluir permanentemente?", onConfirm: async () => { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'planner_budgets', id)); } });

  const handlePrint = (item, type) => {
      const clientDetails = clients.find(c => c.name.toLowerCase() === item.clientName?.toLowerCase());
      const data = {
          type: type, 
          clientName: item.clientName,
          clientAddress: clientDetails?.address || item.clientAddress || 'Endere√ßo n√£o cadastrado',
          clientPhone: clientDetails?.phone || item.clientPhone || '',
          clientEmail: clientDetails?.email || item.clientEmail || '',
          clientPhoto: clientDetails?.photoUrl || item.clientPhotoUrl || null,
          title: item.title, description: item.description, value: item.value, discount: item.discount || 0,
          items: item.items || [], budgetNumber: item.budgetNumber || 'N/A', date: new Date().toLocaleDateString('pt-BR'), issueDate: new Date().toLocaleDateString('pt-BR')
      };
      setPrintData(data); setPrintModalOpen(true);
  };

  // --- NOVAS FUN√á√ïES PARA NEGOCIA√á√ÉO E RESPOSTA ---
  const sendAdminReply = async (budget) => {
      if (!replyText.trim()) return;
      const budgetRef = doc(db, 'artifacts', appId, 'users', user.uid, 'planner_budgets', budget.id);
      const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'tracking_portal', budget.trackingCode);
      
      const updateData = {
          adminResponse: replyText,
          lastUpdate: serverTimestamp()
      };

      await updateDoc(budgetRef, updateData);
      await updateDoc(publicRef, updateData);
      
      setReplyingId(null);
      setReplyText('');
      alert("Resposta enviada ao cliente!");
  };
  
  const acceptClientOffer = async (budget) => {
      requestConfirm({
          title: "Aceitar Oferta do Cliente",
          message: `Deseja aceitar a oferta de ${formatCurrency(budget.clientProposalValue)}? O valor ser√° atualizado e o desconto removido.`,
          confirmText: "Aceitar Oferta",
          variant: "success",
          onConfirm: async () => {
              const budgetRef = doc(db, 'artifacts', appId, 'users', user.uid, 'planner_budgets', budget.id);
              const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'tracking_portal', budget.trackingCode);
              
              const updateData = {
                  value: Number(budget.clientProposalValue),
                  discount: 0, 
                  status: 'Pendente', 
                  lastUpdate: serverTimestamp()
              };

              await updateDoc(budgetRef, updateData);
              await updateDoc(publicRef, updateData);
              alert("Oferta aceita! O or√ßamento foi atualizado.");
          }
      });
  };

  const adminRejectProposal = async (budget) => {
      const budgetRef = doc(db, 'artifacts', appId, 'users', user.uid, 'planner_budgets', budget.id);
      const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'tracking_portal', budget.trackingCode);
      await updateDoc(budgetRef, { status: 'Pendente', clientProposal: null, clientProposalValue: null });
      await updateDoc(publicRef, { status: 'Pendente', clientProposal: null, clientProposalValue: null });
      alert("Proposta recusada. Or√ßamento voltou ao original.");
  };

  // --- PORTAL CLIENTE ---
  const handleTrackOrder = async (e) => {
    e.preventDefault();
    const normalizedCode = trackingCode.trim().toUpperCase(); 
    if (normalizedCode && btoa(normalizedCode) === ACCESS_HASH) { setViewMode('manager'); setTrackingCode(''); setClientViewData(null); return; }
    setClientLoading(true); setClientViewData(null); setRevisionMode(false); setBudgetProposalMode(false);
    try {
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'tracking_portal', normalizedCode);
      const unsubscribe = onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) { setClientViewData({ id: docSnap.id, ...docSnap.data() }); } else { setClientViewData('not-found'); }
        setClientLoading(false);
      });
    } catch (error) { setClientViewData('error'); setClientLoading(false); }
  };

  const clientActionOnBudget = async (action, proposalMsg = '', proposalVal = 0) => {
      if (!clientViewData || !clientViewData.ownerId) return;
      setClientLoading(true);
      try {
          const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'tracking_portal', clientViewData.id);
          const privateRef = doc(db, 'artifacts', appId, 'users', clientViewData.ownerId, 'planner_budgets', clientViewData.budgetId);
          let updateData = {};
          
          if (action === 'approve') {
              updateData = { status: 'Aprovado' };
              const batch = writeBatch(db);
              batch.update(privateRef, { status: 'Aprovado' });
              
              const subtotal = clientViewData.items ? clientViewData.items.reduce((acc, item) => acc + (item.quantity * item.price), 0) : (Number(clientViewData.value) || 0);
              const finalValue = subtotal - (Number(clientViewData.discount) || 0);
              const autoCode = Math.random().toString(36).substring(2, 8).toUpperCase();
              
              const newTaskRef = doc(collection(db, 'artifacts', appId, 'users', clientViewData.ownerId, 'planner_tasks'));
              const serviceData = {
                  title: clientViewData.title, description: clientViewData.description, clientName: clientViewData.clientName,
                  value: finalValue, items: clientViewData.items || [], category: 'Geral', status: 'Triagem', type: 'service',
                  priority: 'M√©dia', manualProgress: 0, trackingCode: autoCode, budgetNumber: clientViewData.budgetNumber,
                  createdAt: serverTimestamp()
              };
              batch.set(newTaskRef, serviceData);

              const newPublicData = {
                  ...clientViewData, ...serviceData, type: 'service', taskId: newTaskRef.id, status: 'Triagem', lastUpdate: serverTimestamp()
              };
              batch.set(publicRef, newPublicData);

              if (clientViewData.isTempClient) {
                  const newClientRef = doc(collection(db, 'artifacts', appId, 'users', clientViewData.ownerId, 'planner_clients_db'));
                  batch.set(newClientRef, {
                      name: clientViewData.clientName, address: clientViewData.clientAddress || '', phone: clientViewData.clientPhone || '',
                      email: clientViewData.clientEmail || '', photoUrl: clientViewData.clientPhotoUrl || '', createdAt: serverTimestamp(),
                      origin: 'budget_auto_conversion'
                  });
                  batch.update(privateRef, { isTempClient: false });
              }

              await batch.commit();
              alert("Parab√©ns! Or√ßamento aprovado e projeto iniciado.");
              
          } else if (action === 'reject') {
              updateData = { status: 'Rejeitado' };
              await updateDoc(publicRef, { ...updateData, lastUpdate: serverTimestamp() });
              await updateDoc(privateRef, updateData);
          } else if (action === 'proposal') {
              updateData = { 
                  status: 'Em Negocia√ß√£o', 
                  clientProposal: proposalMsg,
                  clientProposalValue: proposalVal 
              };
              await updateDoc(publicRef, { ...updateData, lastUpdate: serverTimestamp() });
              await updateDoc(privateRef, updateData);
          }
          setBudgetProposalMode(false); setProposalText(''); setProposalValue('');
      } catch (error) { 
          console.error("Erro:", error); 
          alert("Erro ao processar a√ß√£o. Tente novamente.");
      } finally { setClientLoading(false); }
  };

  // --- RENDER PORTAL LANDING PAGE ---
  const renderLandingPage = () => {
    return (
      <div className="min-h-screen bg-slate-50 flex flex-col font-sans">
        <nav className="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center sticky top-0 z-30 shadow-sm">
           <div className="flex items-center gap-3">
             <img src="https://d2tfco5ldvlr4r.cloudfront.net/profile/210x210/erickanderson.png?m=1644328770120" alt="Erick" className="w-10 h-10 rounded-full border-2 border-slate-200 object-cover shadow-sm" />
             <span className="font-bold text-xl text-slate-800">Planner Erick <span className="text-lime-600">Pro</span></span>
           </div>
           
           {/* Bot√£o de Logout se estiver logado com Google */}
           {user && user.email && (
               <Button variant="ghost" onClick={handleLogout} className="text-sm">
                   Sair
               </Button>
           )}
        </nav>

        <div className="flex-1 flex flex-col items-center justify-center px-4 pb-12 bg-slate-50">
           
           {/* Se n√£o estiver logado com Google e n√£o tiver visualizando dados espec√≠ficos */}
           {!clientViewData && !user?.email && (
               <div className="w-full max-w-md bg-white rounded-3xl shadow-xl border border-slate-200 p-8 transform hover:scale-[1.01] transition-all duration-300">
                   <div className="text-center mb-8">
                       <div className="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-slate-600 shadow-sm border border-slate-200">
                           <LogIn size={32} />
                       </div>
                       <h1 className="text-2xl font-bold text-slate-800">√Årea do Cliente</h1>
                       <p className="text-slate-500 text-sm mt-2">Acesse seus projetos e or√ßamentos.</p>
                   </div>

                   <form onSubmit={handleTrackOrder} className="space-y-4 mb-6">
                       <div>
                           <label className="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">C√≥digo de Acesso</label>
                           <div className="relative">
                               <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                                   <KeyRound size={20} />
                               </div>
                               <input 
                                  type="text" 
                                  placeholder="Digite seu c√≥digo" 
                                  className="w-full pl-12 pr-4 py-4 rounded-xl bg-slate-50 border border-slate-200 text-slate-800 placeholder:text-slate-400 outline-none focus:ring-2 focus:ring-slate-400 focus:border-transparent transition-all font-mono text-lg tracking-wider" 
                                  value={trackingCode} 
                                  onChange={(e) => setTrackingCode(e.target.value)} 
                               />
                           </div>
                       </div>
                       <Button type="submit" className="w-full py-4 text-lg shadow-lg shadow-slate-300 rounded-xl bg-slate-900 text-white hover:bg-slate-800">
                           {clientLoading ? 'Entrando...' : 'Entrar'}
                       </Button>
                   </form>
                   
                   <div className="relative mb-6">
                        <div className="absolute inset-0 flex items-center">
                            <div className="w-full border-t border-slate-200"></div>
                        </div>
                        <div className="relative flex justify-center text-sm">
                            <span className="px-2 bg-white text-slate-500">ou</span>
                        </div>
                   </div>

                   <Button variant="google" onClick={handleGoogleLogin} className="w-full py-3 flex items-center justify-center gap-2 rounded-xl border border-slate-300 hover:bg-slate-50 text-slate-700 shadow-sm">
                        <svg className="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" /><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" /></svg>
                        Google
                   </Button>

                   <div className="mt-8 pt-4 border-t border-slate-100 text-center">
                       <a href="#" onClick={(e) => { e.preventDefault(); alert("Link de contato/vendas"); }} className="text-sm text-slate-500 hover:text-slate-800 transition-colors underline decoration-slate-300 underline-offset-4">Ainda n√£o sou cliente</a>
                   </div>
               </div>
           )}

           {/* ... (Restante das views de erro e dados do cliente mantidos, apenas com ajuste de cores se necess√°rio para consist√™ncia) ... */}
           {clientViewData === 'not-found' && (
               <div className="mt-4 p-4 bg-red-50 border border-red-100 rounded-xl text-red-600 text-sm flex items-center justify-center gap-2 animate-fadeIn max-w-md w-full">
                   <AlertCircle size={16}/> C√≥digo inv√°lido. Tente novamente.
               </div>
           )}
           
           {/* Se estiver logado com Google, mostra lista de projetos */}
           {user?.email && !clientViewData && (
                <div className="w-full max-w-4xl space-y-6">
                    <div className="text-center mb-8">
                        <h2 className="text-2xl font-bold text-slate-800">Ol√°, {user.displayName || user.email}!</h2>
                        <p className="text-slate-500">Selecione um projeto para visualizar os detalhes.</p>
                    </div>
                    
                    {clientProjects.length === 0 ? (
                        <Card className="p-10 text-center">
                            <div className="text-slate-400 mb-4">
                                <Briefcase size={48} className="mx-auto opacity-20"/>
                            </div>
                            <h3 className="text-lg font-bold text-slate-700">Nenhum projeto encontrado</h3>
                            <p className="text-slate-500 text-sm mt-2">N√£o encontramos servi√ßos vinculados ao email <strong>{user.email}</strong>.</p>
                            <p className="text-xs text-slate-400 mt-4">Tente acessar usando o c√≥digo manual se o email for diferente.</p>
                        </Card>
                    ) : (
                        <div className="grid md:grid-cols-2 gap-6">
                            {clientProjects.map(project => (
                                <Card key={project.id} className="p-6 cursor-pointer hover:border-slate-400 transition-all group" onClick={() => setClientViewData(project)}>
                                    <div className="flex justify-between items-start mb-4">
                                        <Badge status={project.status} />
                                        <span className="text-xs text-slate-400 font-mono">#{project.budgetNumber || 'N/A'}</span>
                                    </div>
                                    <h3 className="text-xl font-bold text-slate-800 mb-1 group-hover:text-slate-600 transition-colors">{project.title}</h3>
                                    <p className="text-sm text-slate-500 mb-4">{project.type === 'service' ? 'Projeto em Andamento' : 'Or√ßamento'}</p>
                                    <div className="flex items-center text-xs text-slate-400 gap-2">
                                        <Clock size={14}/> 
                                        Atualizado em: {project.lastUpdate ? new Date(project.lastUpdate.seconds * 1000).toLocaleDateString() : 'Recentemente'}
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                </div>
           )}

           {clientViewData && clientViewData !== 'not-found' && clientViewData !== 'error' && (
              <div className="w-full max-w-3xl bg-white rounded-3xl shadow-xl border border-slate-200 p-8 animate-fadeIn mt-4 relative">
                  <button onClick={() => setClientViewData(null)} className="absolute top-6 right-6 p-2 bg-slate-50 hover:bg-slate-100 rounded-full text-slate-400 hover:text-slate-600 transition-colors">
                      <X size={20}/>
                  </button>

                  {/* VIEW: OR√áAMENTO (BUDGET) */}
                  {clientViewData.type === 'budget' && (
                      <div className="text-center p-4">
                          <Badge status={clientViewData.status} />
                          <h2 className="text-3xl font-bold mt-4 mb-2 text-slate-800">{clientViewData.title}</h2>
                          <p className="text-slate-400 mb-8">Or√ßamento para {clientViewData.clientName}</p>
                          <Button variant="outline" className="mt-4 w-full py-4 text-lg border-2" onClick={() => handlePrint(clientViewData, 'budget')}>üìÑ Acessar Documento Oficial</Button>

                          {/* Proposal UI Logic */}
                          {clientViewData.status === 'Pendente' && !budgetProposalMode && (
                              <div className="grid grid-cols-3 gap-4 mt-8 pt-8 border-t border-slate-100">
                                  <button onClick={() => clientActionOnBudget('reject')} className="p-4 rounded-2xl bg-red-50 text-red-600 font-bold hover:bg-red-100 transition-colors">Rejeitar</button>
                                  <button onClick={() => setBudgetProposalMode(true)} className="p-4 rounded-2xl bg-amber-50 text-amber-600 font-bold hover:bg-amber-100 transition-colors">Nova Proposta</button>
                                  <button onClick={() => clientActionOnBudget('approve')} className="p-4 rounded-2xl bg-emerald-50 text-emerald-600 font-bold hover:bg-emerald-100 transition-colors">Aprovar Agora</button>
                              </div>
                          )}
                          {budgetProposalMode && (
                             <div className="mt-8 bg-amber-50 p-6 rounded-3xl border border-amber-100 animate-fadeIn text-left">
                                 <h4 className="font-bold text-amber-800 mb-3 text-lg">Sua Contraproposta</h4>
                                 
                                 {/* Lista de Itens para Refer√™ncia */}
                                 <div className="bg-white rounded-xl p-4 mb-4 border border-amber-200 max-h-40 overflow-y-auto">
                                     <p className="text-xs font-bold text-slate-400 uppercase mb-2">Itens do Or√ßamento</p>
                                     {clientViewData.items && clientViewData.items.map((item, idx) => (
                                         <div key={idx} className="flex justify-between text-sm text-slate-600 mb-1 border-b border-slate-50 last:border-0 pb-1">
                                             <span>{item.quantity}x {item.description}</span>
                                             <span>{formatCurrency(item.price * item.quantity)}</span>
                                         </div>
                                     ))}
                                     <div className="mt-2 text-right font-bold text-slate-800">
                                         Total Original: {formatCurrency(clientViewData.items ? clientViewData.items.reduce((acc, i) => acc + (i.quantity * i.price), 0) : 0)}
                                     </div>
                                 </div>

                                 <div className="mb-4">
                                     <label className="block text-sm font-bold text-amber-800 mb-1">Sua Oferta (R$)</label>
                                     <input 
                                        type="number" 
                                        className="w-full p-3 border-2 border-amber-200 rounded-xl focus:ring-2 focus:ring-amber-500 text-lg font-bold text-amber-900 bg-white" 
                                        placeholder="0,00"
                                        value={proposalValue} 
                                        onChange={e => setProposalValue(e.target.value)}
                                     />
                                     <p className="text-xs text-amber-600 mt-1">* Insira o valor total que deseja pagar pelos servi√ßos acima.</p>
                                 </div>

                                 <label className="block text-sm font-bold text-amber-800 mb-1">Mensagem / Justificativa</label>
                                 <textarea className="w-full p-4 border-0 rounded-2xl h-24 mb-4 focus:ring-2 focus:ring-amber-400 bg-white" placeholder="Justifique sua proposta..." value={proposalText} onChange={e => setProposalText(e.target.value)}></textarea>
                                 
                                 <div className="flex gap-3 justify-end">
                                     <Button variant="secondary" onClick={() => setBudgetProposalMode(false)}>Cancelar</Button>
                                     <Button variant="warning" icon={Send} onClick={() => clientActionOnBudget('proposal', proposalText, proposalValue)}>Enviar Proposta</Button>
                                 </div>
                             </div>
                         )}

                         {clientViewData.adminResponse && (
                             <div className="mt-6 bg-blue-50 p-4 rounded-xl border border-blue-100 text-left">
                                 <p className="text-xs font-bold text-blue-700 uppercase mb-1">Resposta do Planner:</p>
                                 <p className="text-sm text-slate-700">"{clientViewData.adminResponse}"</p>
                             </div>
                         )}
                      </div>
                  )}

                  {/* VIEW: SERVI√áO (SERVICE) */}
                  {clientViewData.type === 'service' && (
                      <div className="text-center p-4">
                          <Badge status={clientViewData.status} />
                          <h2 className="text-3xl font-bold mt-4 mb-2 text-slate-800">{clientViewData.title}</h2>
                          <div className="my-8">
                              <div className="flex justify-between text-sm font-bold text-slate-400 uppercase tracking-wider mb-2"><span>Progresso</span><span>{clientViewData.manualProgress || 0}%</span></div>
                              <div className="h-4 bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-slate-800 rounded-full transition-all duration-1000" style={{width: `${clientViewData.manualProgress || 0}%`}}></div></div>
                          </div>
                          
                          {clientViewData.status === 'Entregue' && !revisionMode && (
                              <div className="grid grid-cols-2 gap-4 mt-8 pt-8 border-t border-slate-100">
                                  <button onClick={() => setRevisionMode(true)} className="p-4 rounded-2xl bg-amber-50 text-amber-600 font-bold hover:bg-amber-100 transition-colors flex items-center justify-center gap-2"><RefreshCw/> Solicitar Altera√ß√£o</button>
                                  <button onClick={() => updateServiceStatusByClient('Conclu√≠do')} className="p-4 rounded-2xl bg-emerald-50 text-emerald-600 font-bold hover:bg-emerald-100 transition-colors flex items-center justify-center gap-2"><ThumbsUp/> Aprovar Servi√ßo</button>
                              </div>
                          )}

                          {revisionMode && (
                              <div className="mt-8 bg-white p-6 rounded-3xl border-2 border-amber-100 animate-fadeIn text-left shadow-xl">
                                  <h4 className="font-bold text-amber-800 mb-3 text-lg">O que precisa ser ajustado?</h4>
                                  <textarea className="w-full p-4 border border-slate-200 rounded-2xl h-32 mb-4 focus:ring-2 focus:ring-amber-400 bg-slate-50" placeholder="Descreva os ajustes necess√°rios..." value={revisionText} onChange={e => setRevisionText(e.target.value)}></textarea>
                                  <div className="flex gap-3 justify-end">
                                      <Button variant="secondary" onClick={() => setRevisionMode(false)}>Cancelar</Button>
                                      <Button variant="warning" onClick={() => updateServiceStatusByClient('Altera√ß√£o', revisionText)}>Enviar Solicita√ß√£o</Button>
                                  </div>
                              </div>
                          )}
                          
                          <div className="mt-8 pt-8 border-t border-slate-100">
                             <Button variant="outline" className="w-full py-4 text-slate-400 hover:text-slate-600 border-dashed" onClick={() => handlePrint(clientViewData, 'receipt')}>üìÑ Ver Detalhes do Projeto</Button>
                          </div>
                      </div>
                  )}
              </div>
           )}
        </div>
      </div>
    );
  };

  // --- RENDER CONTROL ---
  return (
    <>
      {viewMode === 'landing' ? renderLandingPage() : (
        <div className="flex h-screen bg-slate-50 font-sans text-slate-900 overflow-hidden">
          <aside className="w-20 lg:w-64 bg-white border-r border-slate-200 flex flex-col z-20">
            <div className="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-100">
              <img src="https://d2tfco5ldvlr4r.cloudfront.net/profile/210x210/erickanderson.png?m=1644328770120" alt="Erick" className="w-10 h-10 rounded-full border-2 border-lime-500 object-cover" />
              <span className="ml-3 font-bold text-xl hidden lg:block text-slate-800">Planner Erick <span className="text-lime-500">Pro</span></span>
            </div>
            <nav className="flex-1 py-6 px-3 space-y-2">
              <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'dashboard' ? 'bg-lime-50 text-lime-600' : 'text-slate-500 hover:bg-slate-50'}`}><Layout size={22} /><span className="hidden lg:block">Vis√£o Geral</span></button>
              <button onClick={() => setActiveTab('clients')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'clients' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-500 hover:bg-slate-50'}`}><Users size={22} /><span className="hidden lg:block">Clientes DB</span></button>
              <button onClick={() => setActiveTab('budgets')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'budgets' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-500 hover:bg-slate-50'}`}><FileText size={22} /><span className="hidden lg:block">Or√ßamentos</span></button>
              <button onClick={() => setActiveTab('pipeline')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab === 'pipeline' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-500 hover:bg-slate-50'}`}><Briefcase size={22} /><span className="hidden lg:block">Projetos</span></button>
            </nav>
            <div className="p-4 border-t border-slate-100"><button onClick={() => setViewMode('landing')} className="w-full flex items-center gap-3 px-4 py-3 text-red-500 hover:bg-red-50 rounded-xl transition-all"><LogOut size={20} /><span className="hidden lg:block">Sair</span></button></div>
          </aside>

          <main className="flex-1 flex flex-col min-w-0 bg-slate-50/50">
            <div className="flex-1 overflow-y-auto p-4 lg:p-8">
              <div className="max-w-7xl mx-auto h-full">
                {activeTab === 'dashboard' && <DashboardView />}
                {activeTab === 'clients' && <ClientsView />}
                {activeTab === 'budgets' && <BudgetsView />}
                {activeTab === 'pipeline' && <PipelineBoard />}
              </div>
            </div>
          </main>
        </div>
      )}

      {/* --- MODAIS GLOBAIS --- */}
      
      {/* Modal Add/Edit Cliente */}
      {clientModalOpen && (
          <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl p-6 w-full max-w-md">
                  <h3 className="font-bold text-lg mb-4">{editingId ? 'Editar Cliente' : 'Novo Cliente'}</h3>
                  <form onSubmit={handleSaveClient} className="space-y-4">
                      <input required placeholder="Nome Completo" className="w-full border p-2 rounded" value={newClientData.name} onChange={e=>setNewClientData({...newClientData, name:e.target.value})}/>
                      <input placeholder="URL da Foto (opcional)" className="w-full border p-2 rounded" value={newClientData.photoUrl} onChange={e=>setNewClientData({...newClientData, photoUrl:e.target.value})}/>
                      <input required placeholder="Endere√ßo Completo" className="w-full border p-2 rounded" value={newClientData.address} onChange={e=>setNewClientData({...newClientData, address:e.target.value})}/>
                      <div className="grid grid-cols-2 gap-2">
                          <input placeholder="Telefone" className="w-full border p-2 rounded" value={newClientData.phone} onChange={e=>setNewClientData({...newClientData, phone:e.target.value})}/>
                          <input placeholder="Email" className="w-full border p-2 rounded" value={newClientData.email} onChange={e=>setNewClientData({...newClientData, email:e.target.value})}/>
                      </div>
                      <div className="flex gap-2 mt-4"><Button type="button" variant="secondary" onClick={()=>setClientModalOpen(false)} className="flex-1">Cancelar</Button><Button type="submit" className="flex-1">Salvar</Button></div>
                  </form>
              </div>
          </div>
      )}

      {/* Modal Add/Edit Or√ßamento */}
      {budgetModalOpen && (
          <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                  <h3 className="font-bold text-lg mb-4">{editingId ? 'Editar Or√ßamento' : 'Novo Or√ßamento'}</h3>
                  <form onSubmit={handleSaveBudget} className="space-y-4">
                      {!editingId && (
                          <div className="flex flex-col gap-3 p-3 bg-slate-50 rounded-xl border border-slate-200 mb-4">
                              <div className="flex justify-between items-center">
                                  <span className="text-sm font-bold text-slate-700">O cliente j√° possui cadastro?</span>
                                  <div className="flex gap-2">
                                      <button type="button" onClick={() => setNewBudgetData({...newBudgetData, isExistingClient: true})} className={`px-4 py-1.5 rounded-lg text-sm font-medium transition-colors ${newBudgetData.isExistingClient ? 'bg-lime-600 text-white shadow-sm' : 'bg-white text-slate-600 border border-slate-200'}`}>Sim</button>
                                      <button type="button" onClick={() => setNewBudgetData({...newBudgetData, isExistingClient: false})} className={`px-4 py-1.5 rounded-lg text-sm font-medium transition-colors ${!newBudgetData.isExistingClient ? 'bg-lime-600 text-white shadow-lg' : 'bg-white text-slate-600 border border-slate-200'}`}>N√£o</button>
                                  </div>
                              </div>
                              {!newBudgetData.isExistingClient && (
                                  <div className="pt-3 border-t border-slate-200 animate-fadeIn">
                                      <div className="flex items-center gap-2 mb-3">
                                          <input type="checkbox" id="autoRegister" className="w-4 h-4 text-lime-600 rounded-md focus:ring-0" checked={newBudgetData.autoRegisterClient || false} onChange={(e) => setNewBudgetData({...newBudgetData, autoRegisterClient: e.target.checked})} />
                                          <label htmlFor="autoRegister" className="text-sm text-slate-700 font-medium cursor-pointer">Salvar automaticamente no Banco de Clientes</label>
                                      </div>
                                  </div>
                              )}
                          </div>
                      )}

                      {newBudgetData.isExistingClient ? (
                          <div className="grid grid-cols-2 gap-4">
                              <select className="w-full border p-2 rounded" value={newBudgetData.clientName} onChange={e=>setNewBudgetData({...newBudgetData, clientName:e.target.value})}>
                                  <option value="">Selecione um Cliente</option>
                                  {clients.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                              </select>
                              <input required placeholder="T√≠tulo do Or√ßamento" className="w-full border p-2 rounded" value={newBudgetData.title} onChange={e=>setNewBudgetData({...newBudgetData, title:e.target.value})}/>
                          </div>
                      ) : (
                          <div className="space-y-3 p-3 bg-slate-50 border border-slate-200 rounded-lg">
                              <div className="grid grid-cols-2 gap-4">
                                  <input required placeholder="Nome do Cliente" className="w-full border p-2 rounded" value={newBudgetData.clientName} onChange={e=>setNewBudgetData({...newBudgetData, clientName:e.target.value})}/>
                                  <input required placeholder="T√≠tulo do Or√ßamento" className="w-full border p-2 rounded" value={newBudgetData.title} onChange={e=>setNewBudgetData({...newBudgetData, title:e.target.value})}/>
                              </div>
                              <input placeholder="Endere√ßo" className="w-full border p-2 rounded" value={newBudgetData.clientAddress} onChange={e=>setNewBudgetData({...newBudgetData, clientAddress:e.target.value})}/>
                              <div className="grid grid-cols-2 gap-4">
                                  <input placeholder="Telefone" className="w-full border p-2 rounded" value={newBudgetData.clientPhone} onChange={e=>setNewBudgetData({...newBudgetData, clientPhone:e.target.value})}/>
                                  <input placeholder="Email" className="w-full border p-2 rounded" value={newBudgetData.clientEmail} onChange={e=>setNewBudgetData({...newBudgetData, clientEmail:e.target.value})}/>
                              </div>
                              <input placeholder="URL da Foto (opcional)" className="w-full border p-2 rounded" value={newBudgetData.clientPhotoUrl} onChange={e=>setNewBudgetData({...newBudgetData, clientPhotoUrl:e.target.value})}/>
                          </div>
                      )}
                      
                      <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                          <div className="flex justify-between items-center mb-2">
                              <h4 className="font-bold text-sm text-slate-700 flex items-center gap-2"><ShoppingBag size={16}/> Produtos / Servi√ßos</h4>
                              <Button type="button" onClick={addBudgetItem} variant="outline" className="text-xs px-2 py-1">+ Adicionar Item</Button>
                          </div>
                          
                          <div className="space-y-2">
                              {newBudgetData.items.length === 0 && <p className="text-xs text-slate-400 text-center py-2">Nenhum item adicionado.</p>}
                              {newBudgetData.items.map((item, index) => (
                                  <div key={item.id} className="flex gap-2 items-center">
                                      <span className="text-xs text-slate-400 w-4">{index + 1}.</span>
                                      <input placeholder="Descri√ß√£o do item" className="flex-1 border p-1.5 rounded text-sm" value={item.description} onChange={(e) => updateBudgetItem(item.id, 'description', e.target.value)}/>
                                      <input type="number" placeholder="Qtd" className="w-16 border p-1.5 rounded text-sm text-center" value={item.quantity} onChange={(e) => updateBudgetItem(item.id, 'quantity', Number(e.target.value))}/>
                                      <input type="number" placeholder="Pre√ßo" className="w-24 border p-1.5 rounded text-sm text-right" value={item.price} onChange={(e) => updateBudgetItem(item.id, 'price', Number(e.target.value))}/>
                                      <button type="button" onClick={() => removeBudgetItem(item.id)} className="text-red-400 hover:text-red-600 p-1"><Trash2 size={16}/></button>
                                  </div>
                              ))}
                          </div>
                          
                          <div className="mt-4 pt-4 border-t border-slate-200 flex justify-end items-center gap-4">
                              <div className="text-sm"><span className="text-slate-500 mr-2">Desconto (R$):</span><input type="number" className="border p-1 rounded w-24 text-right" value={newBudgetData.discount} onChange={e=>setNewBudgetData({...newBudgetData, discount:e.target.value})}/></div>
                              <div className="text-right"><p className="text-xs text-slate-500 uppercase">Total Final</p><p className="text-xl font-bold text-emerald-600">{formatCurrency(calculateBudgetTotal(newBudgetData.items) - (Number(newBudgetData.discount) || 0))}</p></div>
                          </div>
                      </div>
                      <div className="flex gap-2 mt-4"><Button type="button" variant="secondary" onClick={()=>setBudgetModalOpen(false)} className="flex-1">Cancelar</Button><Button type="submit" className="flex-1">Salvar</Button></div>
                  </form>
              </div>
          </div>
      )}

      {/* Modal Add/Edit Projeto */}
      {newTaskModalOpen && (
        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
           <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 overflow-y-auto max-h-[90vh]">
              <h3 className="font-bold text-lg mb-4">{editingId ? 'Editar Projeto' : 'Novo Projeto'}</h3>
              <form onSubmit={handleSaveTask} className="space-y-4">
                <select className="w-full border p-2 rounded-lg bg-white" value={newTaskData.clientName} onChange={e=>setNewTaskData({...newTaskData, clientName:e.target.value})}>
                    <option value="">Selecione o Cliente</option>
                    {clients.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                </select>
                <input required placeholder="T√≠tulo do Servi√ßo" className="w-full border p-2 rounded-lg" value={newTaskData.title} onChange={e=>setNewTaskData({...newTaskData, title:e.target.value})} />
                <input type="number" placeholder="Valor (R$)" className="w-full border p-2 rounded-lg" value={newTaskData.value} onChange={e=>setNewTaskData({...newTaskData, value:e.target.value})} />
                <textarea placeholder="Descri√ß√£o" className="w-full border p-2 rounded-lg h-20" value={newTaskData.description} onChange={e=>setNewTaskData({...newTaskData, description:e.target.value})} />
                <div className="grid grid-cols-2 gap-3">
                    <div><label className="text-xs">In√≠cio</label><input type="datetime-local" className="w-full border p-2 rounded-lg text-sm" value={newTaskData.startTime} onChange={e=>setNewTaskData({...newTaskData, startTime:e.target.value})} /></div>
                    <div><label className="text-xs">Entrega</label><input type="datetime-local" className="w-full border p-2 rounded-lg text-sm" value={newTaskData.endTime} onChange={e=>setNewTaskData({...newTaskData, endTime:e.target.value})} /></div>
                </div>
                <div className="flex gap-2 mt-4"><Button type="button" variant="secondary" onClick={()=>setNewTaskModalOpen(false)} className="flex-1">Cancelar</Button><Button type="submit" className="flex-1">Salvar</Button></div>
              </form>
           </div>
        </div>
      )}

      {/* Confirmation Modal */}
      {confirmModal.isOpen && (
        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[200] flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 animate-fadeIn">
            <h3 className="font-bold text-lg text-slate-800 mb-2">{confirmModal.title}</h3>
            <p className="text-slate-600 mb-6">{confirmModal.message}</p>
            <div className="flex gap-3">
              <Button type="button" variant="secondary" onClick={() => setConfirmModal({...confirmModal, isOpen: false})} className="flex-1">Cancelar</Button>
              <Button type="button" variant={confirmModal.variant} onClick={() => { confirmModal.onConfirm(); setConfirmModal({...confirmModal, isOpen: false}); }} className="flex-1">{confirmModal.confirmText}</Button>
            </div>
          </div>
        </div>
      )}

      {/* Modal Impress√£o */}
      {printModalOpen && printData && (
          <div className="fixed inset-0 bg-white z-[300] flex flex-col overflow-auto p-8">
              {/* Conte√∫do de Impress√£o */}
              <div className="max-w-3xl mx-auto w-full border border-black p-10 font-serif text-black relative" id="printable-area">
                  <div className="text-center border-b-2 border-black pb-6 mb-6">
                      <h1 className="text-4xl font-bold uppercase tracking-widest">{printData.type === 'budget' ? 'Or√ßamento' : 'Nota de Servi√ßo'}</h1>
                      <p className="text-sm mt-2">N¬∫: <strong>#{printData.budgetNumber}</strong></p>
                      <p className="text-sm">Data: {printData.issueDate}</p>
                  </div>
                  <div className="mb-8 p-4 border border-black rounded flex justify-between">
                      <div>
                          <h3 className="font-bold border-b border-black mb-2 uppercase text-sm w-max">Dados do Cliente</h3>
                          <div className="flex items-center gap-3">
                              {printData.clientPhoto && <img src={printData.clientPhoto} className="w-12 h-12 rounded-full border border-slate-300 object-cover print:hidden"/>}
                              <div>
                                <p className="text-lg font-bold">{printData.clientName}</p>
                                <p>{printData.clientAddress}</p>
                                <p>{printData.clientPhone}</p>
                              </div>
                          </div>
                      </div>
                      <div className="text-right">
                          <h3 className="font-bold border-b border-black mb-2 uppercase text-sm inline-block">Refer√™ncia</h3>
                          <p className="font-bold">{printData.title}</p>
                      </div>
                  </div>
                  {printData.items && printData.items.length > 0 ? (
                      <div className="mb-8">
                          <table className="w-full text-sm border-collapse border border-black">
                              <thead><tr className="bg-gray-100"><th className="border border-black p-2 text-left">Descri√ß√£o</th><th className="border border-black p-2 text-center w-20">Qtd</th><th className="border border-black p-2 text-right w-32">Unit.</th><th className="border border-black p-2 text-right w-32">Total</th></tr></thead>
                              <tbody>
                                  {printData.items.map((item, idx) => (<tr key={idx}><td className="border border-black p-2">{item.description}</td><td className="border border-black p-2 text-center">{item.quantity}</td><td className="border border-black p-2 text-right">{formatCurrency(item.price)}</td><td className="border border-black p-2 text-right">{formatCurrency(item.quantity * item.price)}</td></tr>))}
                              </tbody>
                          </table>
                      </div>
                  ) : (<div className="mb-8 min-h-[100px] border border-black p-4"><h3 className="font-bold border-b border-black mb-2 uppercase text-sm w-max">Descri√ß√£o</h3><p className="whitespace-pre-line text-slate-800">{printData.description || 'Servi√ßo prestado.'}</p></div>)}
                  <div className="flex justify-end mt-4 pt-4">
                      <div className="text-right min-w-[250px]">
                          {printData.items && printData.items.length > 0 ? (
                              <>
                                  <div className="flex justify-between mb-1 text-sm"><span>Subtotal:</span><span className="font-bold">{formatCurrency(printData.items.reduce((acc, i) => acc + (i.quantity * i.price), 0))}</span></div>
                                  {printData.discount > 0 && (<div className="flex justify-between mb-2 text-sm text-red-600"><span>Desconto:</span><span>- {formatCurrency(printData.discount)}</span></div>)}
                                  <div className="flex justify-between border-t-2 border-black pt-2 mt-2"><span className="text-xl uppercase font-bold">Total a Pagar</span><span className="text-2xl font-bold">{formatCurrency(printData.items.reduce((acc, i) => acc + (i.quantity * i.price), 0) - (printData.discount || 0))}</span></div>
                              </>
                          ) : (<div className="flex justify-between border-t-2 border-black pt-2 mt-2"><span className="text-xl uppercase font-bold">Total:</span><span className="text-2xl font-bold">{formatCurrency(printData.value)}</span></div>)}
                      </div>
                  </div>
                  <div className="mt-20 pt-8 border-t border-black text-center text-xs"><p>Obrigado pela prefer√™ncia!</p></div>
              </div>
              <div className="fixed top-4 right-4 flex gap-4 print:hidden"><Button type="button" variant="secondary" onClick={() => setPrintModalOpen(false)}>Fechar</Button><Button type="button" onClick={() => window.print()} icon={Printer}>Imprimir</Button></div>
              <style>{`@media print { .print\\:hidden { display: none; } body { background: white; } #printable-area { border: none; box-shadow: none; width: 100%; max-width: 100%; } }`}</style>
          </div>
      )}

      {/* Modal Edi√ß√£o de Cr√©ditos */}
      {creditEditModal.open && (
        <div className="fixed inset-0 bg-slate-900/30 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
           <div className="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 animate-fadeIn text-center">
              <h3 className="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2"><Coins className="text-amber-500" /> Gerenciar Cr√©ditos</h3>
              <p className="text-sm text-slate-500 mb-4">Ajustar saldo para <strong>{creditEditModal.clientName}</strong></p>
              <div className="flex items-center gap-4 justify-center mb-6">
                  <button onClick={() => setCreditEditModal({...creditEditModal, currentCredits: Math.max(0, Number(creditEditModal.currentCredits) - 1)})} className="w-10 h-10 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200"><Minus size={20}/></button>
                  <input type="number" className="w-20 text-center text-2xl font-bold border-b-2 border-indigo-200 focus:border-indigo-500 outline-none" value={creditEditModal.currentCredits} onChange={e => setCreditEditModal({...creditEditModal, currentCredits: e.target.value})}/>
                  <button onClick={() => setCreditEditModal({...creditEditModal, currentCredits: Number(creditEditModal.currentCredits) + 1})} className="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center hover:bg-emerald-200"><Plus size={20}/></button>
              </div>
              <div className="flex gap-2">
                  <Button type="button" variant="secondary" onClick={() => setCreditEditModal({open: false, clientName: '', currentCredits: 0})} className="flex-1">Cancelar</Button>
                  <Button type="button" onClick={() => { updateClientCredits(creditEditModal.clientName, creditEditModal.currentCredits); setCreditEditModal({open: false, clientName: '', currentCredits: 0}); }} className="flex-1">Salvar</Button>
              </div>
           </div>
        </div>
      )}

      {shareModalOpen && (
        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center animate-fadeIn border border-slate-100">
            <div className="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-6 text-indigo-600 shadow-inner">
                <KeyRound size={40} />
            </div>
            <h3 className="font-bold text-2xl text-slate-800 mb-2">Acesso do Cliente</h3>
            <p className="text-slate-500 mb-6 text-base leading-relaxed">
                Envie o c√≥digo abaixo para seu cliente acessar o or√ßamento e aprovar online:
            </p>
            
            <div 
                className="bg-slate-50 p-6 rounded-2xl flex items-center justify-between mb-8 border-2 border-slate-200 group hover:border-lime-500 transition-all cursor-pointer relative overflow-hidden" 
                onClick={() => handleCopy(lastGeneratedCode)}
                title="Clique para copiar"
            >
                <div className="absolute inset-0 bg-lime-50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                <span className="font-mono text-4xl font-black text-slate-800 tracking-widest relative z-10">{lastGeneratedCode}</span>
                <button className="text-slate-400 group-hover:text-lime-600 transition-colors relative z-10">
                    <Copy size={24} />
                </button>
            </div>
            
            <p className="text-xs text-slate-400 mb-6">O cliente deve digitar este c√≥digo na p√°gina inicial.</p>

            <Button type="button" onClick={() => setShareModalOpen(false)} className="w-full justify-center py-4 text-lg bg-slate-900 hover:bg-slate-800 text-white shadow-xl">
                Fechar
            </Button>
          </div>
        </div>
      )}

      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
      `}</style>
    </>
  );
}